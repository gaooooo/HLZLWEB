<!DOCTYPE>
<html ng-app="app">

<head>
    <title>58Question-type</title>
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
    <link rel="stylesheet" href="../../lib/bootstrap/css/bootstrap.min.css" />
    <link rel="stylesheet" href="../../lib/angular/angular-csp.css" />
    <link rel="stylesheet" href="../../lib/ng-table/ng-table.min.css" />
    <style type="text/css">
        .items span {
            display: inline-block;
            width: 150px;
            text-align: right;
        }
        
        input[type=text] {
            width: 300px!important;
        }
        
        .panel-item {
            padding: 30px;
            width: 49%;
            float: left;
        }
        
        tr.selected {
            border: 2px solid #B9B6B6!important;
        }
    </style>
</head>

<body>
    <p>
        <a target="_self" href="/page/question/question.html">跳转到问题页面</a>
        <a target="_self" href="/page/question/question-type.html">跳转到问题分类页面</a>
    </p>
    <div class="panel-item ng-cloak" ng-controller="leftController as vm" ng-init="vm.currentData={}">
        <button class="btn" type="button" ng-click="search()">刷新</button><span>{{loading?'loading...':''}}</span>
        <span class="info">{{info}}</span>
        <table ng-table="vm.tableParams" class="table table-bordered table-condensed table-hover" show-filter="false">
            <tr ng-class="{selected:vm.currentData===row}" ng-repeat="row in $data track by $index">
                <td data-title="'##'">
                    <input type="radio" ng-checked="vm.currentData===row">
                </td>
                <td data-title="'添加人'" style="width:100px;">
                    {{row.addUser}}</td>
                <td data-title="'描述'" style="width:200px;">
                    {{row.description}}</td>
                <td data-title="'分类id'" style="width:200px;">
                    {{row.id}}</td>
                <td data-title="'名称'" style="width:200px;">
                    {{row.name}}</td>
                <td data-title="'关联id'" style="width:200px;">
                    {{row.relationId}}</td>
                <td data-title="'顺序'" style="width:200px;">
                    {{row.turn}}</td>
                <td data-title="'类别'" style="width:200px;">
                    {{row.type|typeFilter}}</td>
                <td data-title="'操作'" style="width:100px;">
                    <!--<button class="btn btn-primary btn-sm"><span class="glyphicon glyphicon-ok"></span></button>-->
                    <!--<button class="btn btn-default btn-sm"><span class="glyphicon glyphicon-remove"></span></button>-->
                    <button class="btn btn-default btn-sm" ng-click="vm.currentData=row;selectRow(row);"><span class="glyphicon glyphicon-pencil"></span></button>
                    <button class="btn btn-danger btn-sm" ng-click="delete(row)"><span class="glyphicon glyphicon-trash"></span></button>
                </td>
            </tr>
        </table>
    </div>
    <div class="items panel-item" ng-controller="rightController as vm">
        <h1>上传问题分类</h1>
        <h3>{{vm.data.id?'修改模式':'添加模式'}}</h3>
        <p> <span>问题分类名称</span><input type="text" ng-model="vm.data.name"></p>
        <p> <span>问题分类描述</span><input type="text" ng-model="vm.data.description"></p>
        <p> <span>问题分类类别</span>
            <label ng-repeat="item in typeItems track by $index">
            <input type="radio" ng-change="typeChange()" ng-value="item.id" ng-model="vm.data.type">{{item.text}}
            </label>
        </p>
        <p> <span>分类顺序</span><input type="text" ng-model="vm.data.turn"></p>
        <p> <span>平台</span>
            <label ng-repeat="item in platformItems track by $index">
            <input type="radio" ng-value="item.id" ng-model="vm.data.platform">{{item.text}}
            </label>
        </p>
        <p> <span>安卓渠道</span><input type="text" ng-model="vm.data.andrChannel"></p>
        <p> <span>安卓版本</span><input type="text" ng-model="vm.data.andrVersion"></p>
        <p> <span>ios渠道</span><input type="text" ng-model="vm.data.iosChannel"></p>
        <p> <span>ios版本</span><input type="text" ng-model="vm.data.iosVersion"></p>
        <p> <span>城市</span><input type="text" ng-model="vm.data.city"></p>
        <p> <span>上线开始时间</span><input type="text" ng-model="vm.data.startTime">如:2016-12-19 15:00:00</p>
        <p> <span>上线结束时间</span><input type="text" ng-model="vm.data.endTime">如:2016-12-19 15:00:00</p>
        <p> <span>添加人</span><input type="text" ng-model="vm.data.addUser"></p>
        <p ng-if="vm.data.type==1"> <span>关联id</span><input type="text" ng-model="vm.data.relationId"></p>
        <div>
            <button type="button" class="btn" ng-click="saveQuestion()">提交内容</button>
            <button type="button" class="btn" ng-click="setReset()">重置内容以新增</button>
            <br/>
            <span>{{result}}</span>
            <span>{{error}}</span>
        </div>
        <fieldset style="display:none;">
            <legend>当前数据: </legend>
            <div>{{vm.data}}</div>
        </fieldset>
    </div>

    <script type="text/javascript" src="../../ueditor/ueditor.config.js"></script>
    <script type="text/javascript" src="../../ueditor/ueditor.all.min.js">
    </script>
    <!--建议手动加在语言，避免在ie下有时因为加载语言失败导致编辑器加载失败-->
    <!--这里加载的语言文件会覆盖你在配置项目里添加的语言类型，比如你在配置项目里配置的是英文，这里加载的中文，那最后就是中文-->
    <script type="text/javascript" src="../../ueditor/lang/zh-cn/zh-cn.js"></script>
    <script type="text/javascript" src="../../ueditor/ueditor-helper.js">
    </script>
    <script src="../../lib/underscore/underscore.js"></script>
    <script src="../../lib/angular/angular.min.js"></script>
    <script src="../../lib/ng-table/ng-table.min.js"></script>
    <script>
        var app = angular.module('app', ["ngTable"]);
        //左侧控制器-----------------------------------------------------------
        app.controller('leftController', function($scope, $http, $timeout, NgTableParams, $q, questionBridge) {
            var self = this;
            var data = _.map(new Array(13), function(item, i) {
                return {
                    name: "---Moroni" + i,
                    age: 50 + i,
                    createTime: new Date()
                }
            });
            $scope.selectRow = function(data) {
                questionBridge.setData(angular.copy(data));
            }
            $scope.delete = function(data) {
                if (confirm('确定删除此条数据')) {
                    $http({
                        url: '/question/deleteQuestionType',
                        method: 'GET',
                        params: {
                            id: data.id
                        }
                    }).then(function() {
                        $scope.info = '删除成功';
                        $scope.search();
                        $timeout(function() {
                            $scope.info = '';
                        }, 2000);
                    });
                }
            }
            questionBridge.search = $scope.search = function() {
                $timeout(function() {
                    self.tableParams.reload();
                }, 50);
            }
            self.tableParams = new NgTableParams({}, {
                // dataset: data,
                getData: function(params) {
                    var promiseData = $q.defer();
                    $scope.loading = true;
                    $http({
                        url: '/question/getQuestionTypePage',
                        method: 'GET',
                        params: {
                            page: params.page()
                        }
                    }).then(function(response) {
                        if (response.data.result) {
                            promiseData.resolve(response.data.result);
                        }
                    }).finally(function() {
                        $scope.loading = false;
                    });
                    return promiseData.promise;
                },
                counts: [10],
            });
        });
        app.service('questionBridge', function() {

        });
        var typeItems = [{
            id: 0,
            text: '问题分类'
        }, {
            id: 1,
            text: '反馈分类'
        }, {
            id: 2,
            text: '公告分类'
        }, {
            id: 3,
            text: '热点问题分类'
        }];
        app.filter('typeFilter', function() {
            return function(value) {
                var result = '';
                _.each(typeItems, function(item, i) {
                    if (item.id == value) {
                        result = item.text;
                    }
                });
                return result;
            }
        });
        //右侧控制器-------------------------------------------------
        app.controller('rightController', function($scope, $http, $timeout, questionBridge) {
            var me = this;
            me.data = {
                type: 0,
                platform: ''
            };
            $scope.typeItems = typeItems;
            $scope.platformItems = [{
                id: '',
                text: '全部'
            }, {
                id: 'android',
                text: 'android'
            }, {
                id: 'ios',
                text: 'ios'
            }];
            $scope.typeChange = function() {
                if (me.data.type !== 1) {
                    me.data.relationId = '';
                }
            }
            questionBridge.setData = function(data) {
                me.data = data;
            }
            $scope.setReset = function() {
                me.data = {
                    type: 1,
                    platform: 'android'
                };
                setContent('', false);
                $scope.result = '';
                $scope.error = '';
            }
            $scope.saveQuestion = function() {
                $scope.result = '提交中';
                $http({
                    url: me.data.id ? '/question/updateQuestionType' : '/question/addQuestionType',
                    method: 'POST',
                    data: {
                        data: me.data
                    }
                }).then((result) => {
                    if (result.data.result === true) {
                        $scope.result = '保存成功';
                        $scope.setReset();
                        questionBridge.search();
                        $timeout(function() {
                            $scope.result = '';
                            $scope.error = '';
                        }, 2000);
                    } else {
                        $scope.result = '保存失败';
                        $scope.error = result.data.error;
                    }

                });
            }
        });
    </script>
</body>

</html>